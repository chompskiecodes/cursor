# Database Tables and Views

## Tables

- **clinics**: Multi-tenant clinics, includes timezone and API key info
  - Columns: clinic_id, clinic_name, phone_number, cliniko_api_key, cliniko_shard, active, contact_email, elevenlabs_agent_id, created_at, updated_at, timezone
- **businesses**: Physical locations/branches (Cliniko business_id)
  - Columns: business_id, clinic_id, business_name, is_primary, created_at
- **practitioners**: Practitioners (linked to clinics)
  - Columns: practitioner_id, clinic_id, first_name, last_name, title, active, default_appointment_type_id, created_at
- **billable_items**: Billable items/services for clinics
  - Columns: item_id, clinic_id, item_name, price, active
- **appointment_types**: Appointment types/services
  - Columns: appointment_type_id, clinic_id, name, duration_minutes, billable_item_id, active
- **patients**: Patients (unique per clinic)
  - Columns: patient_id, clinic_id, phone_number, first_name, last_name, email, created_at, updated_at
- **appointments**: Appointments (booked, confirmed, cancelled, completed)
  - Columns: appointment_id, clinic_id, patient_id, practitioner_id, appointment_type_id, business_id, starts_at, ends_at, status, notes, created_at, updated_at
- **voice_bookings**: Voice booking logs for audit/tracking
  - Columns: booking_id, appointment_id, clinic_id, session_id, caller_phone, action, status, error_message, created_at
- **phone_lookup**: Normalized phone lookup for clinics
  - Columns: phone_normalized, clinic_id, created_at
- **location_aliases**: Aliases for business/location names
  - Columns: id, business_id, alias, created_at
- **elevenlabs_numbers**: Phone numbers for ElevenLabs integration
  - Columns: id, clinic_id, business_id, phone_number, phone_normalized, description, is_active, created_at, updated_at
- **practitioner_businesses**: Junction table (practitioner ↔ business)
  - Columns: practitioner_id, business_id
- **practitioner_appointment_types**: Junction table (practitioner ↔ appointment type)
  - Columns: practitioner_id, appointment_type_id
- **availability_cache**: Cached availability per practitioner/business/date
  - Columns: cache_id, clinic_id, practitioner_id, business_id, date, available_slots, cached_at, expires_at, is_stale
- **booking_context_cache**: Cached booking context per phone/clinic
  - Columns: phone_normalized, clinic_id, context_data, cached_at, expires_at, hit_count, last_accessed
- **patient_cache**: Cached patient data per phone/clinic
  - Columns: cache_id, phone_normalized, clinic_id, patient_id, patient_data, cached_at, expires_at
- **service_match_cache**: Cached service match results
  - Columns: cache_id, cache_key, clinic_id, search_term, matches, usage_count, cached_at, expires_at
- **cache_statistics**: Cache performance stats (partitioned)
  - Columns: stat_date, cache_type, hit_count, miss_count, refresh_count, api_calls_saved, avg_response_time_ms, created_at
- **failed_booking_attempts**: Tracks failed booking attempts for practitioners
  - Columns: clinic_id, practitioner_id, business_id, appointment_date, appointment_time, failure_reason, created_at
- **cache_performance_log**: Logs cache performance/cleanup
  - Columns: id, operation_type, cache_type, response_time_ms, cache_size_bytes, hit_ratio, created_at
- **booking_locks**: Prevents concurrent bookings for same slot
  - Columns: practitioner_id, appointment_start, session_id, locked_at, expires_at
- **cache_warmup_log**: Tracks cache warmup operations
  - Columns: id, clinic_id, warmup_type, practitioners_warmed, days_warmed, total_slots_cached, duration_ms, success, error_message, created_at
- **cache_alert_thresholds**: Alert thresholds for cache health
  - Columns: id, metric_name, threshold_value, alert_enabled, description
- **cache_slow_queries**: Logs slow cache queries
  - Columns: id, operation, duration_ms, cache_type, query_details, created_at

## Views

- **v_phone_lookup**: Lookup view for clinic and patient phone numbers
  - Columns: clinic_id, clinic_phone, clinic_phone_normalized, patient_id, patient_phone, patient_phone_normalized
- **v_available_services_with_business**: Services with business and practitioner info
  - Columns: appointment_type_id, service_name, duration_minutes, item_name, price, practitioner_id, practitioner_name, business_id, business_name, is_primary, clinic_id, clinic_name
- **v_available_services**: Backward compatibility view for available services
  - Columns: appointment_type_id, service_name, duration_minutes, item_name, price, practitioner_id, practitioner_name, clinic_id, clinic_name
- **v_business_lookup**: Lookup for businesses and aliases
  - Columns: business_id, business_name, is_primary, clinic_id, clinic_name, clinic_phone, business_name_lower, business_aliases
- **v_practitioner_locations**: Practitioner locations and business info
  - Columns: practitioner_id, practitioner_name, business_id, business_name, is_primary, clinic_id
- **v_comprehensive_services**: Comprehensive services with practitioner and business
  - Columns: appointment_type_id, service_name, duration_minutes, item_name, price, practitioner_id, practitioner_name, practitioner_first_name, practitioner_last_name, practitioner_title, business_id, business_name, is_primary_location, clinic_id, clinic_name, clinic_phone, service_name_search, practitioner_name_search, practitioner_first_search, practitioner_last_search, business_name_search
- **v_elevenlabs_numbers**: Active ElevenLabs numbers with clinic/business info
  - Columns: id, phone_number, phone_normalized, description, is_active, clinic_id, clinic_name, business_id, business_name, created_at, updated_at
- **v_location_names**: Business/location names and aliases
  - Columns: business_id, business_name, is_primary, clinic_id, clinic_name, aliases
- **v_cache_efficiency**: Cache efficiency stats (hourly)
  - Columns: cache_type, hour, hits, misses, hit_rate, api_calls_saved, avg_response_ms
- **v_cache_status**: Cache status summary for all cache tables
  - Columns: cache_type, total_entries, valid_entries, stale_entries, oldest_entry, newest_entry
- **v_availability_cache_details**: Details of cached availability slots
  - Columns: cache_id, date, practitioner_id, practitioner_name, business_id, business_name, available_slots, slot_count, cached_at, expires_at, is_stale, clinic_name
- **v_cache_hit_rates**: Cache hit rates by type/hour
  - Columns: cache_type, hour, hits, misses, hit_rate_pct, api_calls_saved
- **v_cache_sizes**: Cache table sizes and valid entry counts
  - Columns: cache_name, total_entries, valid_entries, table_size 